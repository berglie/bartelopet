#!/bin/sh
# Pre-commit hook for running Prettier on staged files
# This ensures consistent code formatting across the project

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if pnpm is available
if ! which pnpm > /dev/null 2>&1; then
    echo "${YELLOW}⚠️  pnpm is not installed. Skipping prettier check.${NC}"
    echo "   Install pnpm to enable automatic code formatting."
    exit 0
fi

echo "${GREEN}✨ Running Prettier on staged files...${NC}"

# Get list of staged files that Prettier can format
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx|json|css|md|mdx|yml|yaml)$')

if [ -z "$STAGED_FILES" ]; then
    echo "${GREEN}✅ No files to format.${NC}"
    exit 0
fi

# Count files
FILE_COUNT=$(echo "$STAGED_FILES" | wc -l)
echo "   Formatting $FILE_COUNT file(s)..."

# Format staged files
echo "$STAGED_FILES" | xargs pnpm prettier --write

# Check if prettier made any changes
if [ $? -ne 0 ]; then
    echo "${RED}❌ Prettier formatting failed!${NC}"
    echo "   Please fix the errors and try again."
    exit 1
fi

# Add formatted files back to staging
echo "$STAGED_FILES" | xargs git add

echo "${GREEN}✅ Prettier formatting complete!${NC}"
echo "   All staged files have been formatted."
exit 0